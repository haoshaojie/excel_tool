{"remainingRequest":"F:\\东方通\\source\\b_zwj\\xinhua-finance-web\\node_modules\\vue-loader\\lib\\index.js??vue-loader-options!F:\\东方通\\source\\b_zwj\\xinhua-finance-web\\src\\views\\contract\\product\\group\\group-add.vue?vue&type=style&index=0&lang=css&","dependencies":[{"path":"F:\\东方通\\source\\b_zwj\\xinhua-finance-web\\src\\views\\contract\\product\\group\\group-add.vue","mtime":1618541026422},{"path":"F:\\东方通\\source\\b_zwj\\xinhua-finance-web\\node_modules\\css-loader\\index.js","mtime":499162500000},{"path":"F:\\东方通\\source\\b_zwj\\xinhua-finance-web\\node_modules\\vue-loader\\lib\\loaders\\stylePostLoader.js","mtime":499162500000},{"path":"F:\\东方通\\source\\b_zwj\\xinhua-finance-web\\node_modules\\postcss-loader\\src\\index.js","mtime":499162500000},{"path":"F:\\东方通\\source\\b_zwj\\xinhua-finance-web\\node_modules\\cache-loader\\dist\\cjs.js","mtime":499162500000},{"path":"F:\\东方通\\source\\b_zwj\\xinhua-finance-web\\node_modules\\vue-loader\\lib\\index.js","mtime":499162500000}],"contextDependencies":[],"result":["\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n.header .el-page-header__content {\n  font-size: 14px;\n  font-weight: 500;\n  color: #303133;\n}\n",{"version":3,"sources":["group-add.vue"],"names":[],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AA2PA;AACA;AACA;AACA;AACA","file":"group-add.vue","sourceRoot":"src/views/contract/product/group","sourcesContent":["<template>\r\n  <basic-container>\r\n    <template>\r\n      <el-row>\r\n        <el-col :span=\"16\">\r\n          <el-page-header @back=\"goBack\" :content=\"title\" class=\"header\">\r\n          </el-page-header>\r\n        </el-col>\r\n        <el-col :span=\"8\">\r\n          <el-row v-if=\"!isView\" style='float:right'>\r\n            <el-button size=\"small\" v-if=\"!btnState\" type=\"primary\" @click.native=\"save(4)\">保存至草稿</el-button>\r\n            <el-button size=\"small\" v-if=\"!btnState\"  @click.native=\"save(3)\">保存暂不上架</el-button>\r\n            <el-button size=\"small\" v-if=\"!btnState\" type=\"primary\" @click.native=\"save(1)\">保存并上架</el-button>\r\n            <el-button size=\"small\" v-if=\"btnState\" type=\"primary\" @click.native=\"save(5)\">保存</el-button>\r\n          </el-row>\r\n        </el-col>\r\n      </el-row>\r\n    </template>\r\n    <template>\r\n      <el-tabs v-model=\"activeName\" @tab-click=\"handleClick\">\r\n        <el-tab-pane label=\"基础信息\" name=\"baseInfo\">\r\n          <baseInfo ref=\"baseInfo\" :baseInfo=\"form.baseInfo\" :is-view=\"isView\"></baseInfo>\r\n        </el-tab-pane>\r\n        <el-tab-pane label=\"产品\" name=\"prodInfo\" >\r\n          <prodInfo ref=\"prodInfo\" :prodInfo=\"form.prodInfo\" :is-view=\"isView\"></prodInfo>\r\n        </el-tab-pane>\r\n        <el-tab-pane label=\"产品项\" name=\"priceInfo\">\r\n          <itemInfo ref=\"itemInfo\" :itemInfo=\"form.itemInfo\" :is-view=\"isView\"></itemInfo>\r\n        </el-tab-pane>\r\n        <el-tab-pane label=\"折扣信息\" name=\"profitInfo\">\r\n          <rebateInfo ref=\"rebateInfo\" :rebateInfo=\"form.baseInfo\" :is-view=\"isView\"></rebateInfo>\r\n        </el-tab-pane>\r\n      </el-tabs>\r\n    </template>\r\n  </basic-container>\r\n</template>\r\n<script>\r\nimport {add,getDetail,update} from \"@/api/contract/product/group\";\r\nimport {getProdAddedList} from \"@/api/contract/product/product\";\r\nimport {getItemAddedList} from \"@/api/contract/product/productitem\";\r\nimport baseInfo from \"./baseInfo\"\r\nimport rebateInfo from \"./rebateInfo\"\r\nimport prodInfo from \"./prodInfo\"\r\nimport itemInfo from \"./itemInfo\"\r\n\r\nexport default {\r\n  name:\"product-add\",\r\n  components:{baseInfo, prodInfo, itemInfo, rebateInfo},\r\n  props:{\r\n    id:'',\r\n    title:\"新增\",\r\n    isView:false\r\n  },\r\n  data(){\r\n    return {\r\n      activeName: 'baseInfo',\r\n      headers:{},\r\n      loading:false,\r\n      btnState:false,\r\n      picFiles:[],\r\n      prodIds:[],\r\n      itemIds:[],\r\n      form:{\r\n        baseInfo:{\r\n          id:'',\r\n          prodName: '',\r\n          propDept: '',\r\n          addedDate: '',\r\n          expiredDate: '',\r\n          discount:'',\r\n          prodState:''\r\n        },\r\n        prodInfo:{\r\n          products:[]\r\n        },\r\n        itemInfo:{\r\n          items:[]\r\n        }\r\n      }\r\n    }\r\n  },\r\n  mounted() {\r\n    if(this.id){\r\n      if(this.isView){\r\n        this.title=\"详情\";\r\n      }else{\r\n        this.title=\"编辑\";\r\n      }\r\n      this.detail();\r\n    }else{\r\n      this.title=\"新增\";\r\n    }\r\n  },\r\n  methods: {\r\n    detail(){\r\n      let _this = this\r\n      this.loading = true;\r\n      getDetail(_this.id).then(res =>{\r\n        let data = res.data.data;\r\n        this.form.baseInfo = data;\r\n        this.form.baseInfo.propDept = data.propDept?data.propDept:'';\r\n        if(data.prodState == 1){\r\n          this.btnState =true;\r\n        }\r\n        let detailList = data.detailList;\r\n        let products=[];\r\n        let items=[];\r\n        for(let detail of detailList){\r\n          if(detail.type == 1){// 1产品2产品项\r\n            products.push(detail)\r\n            this.prodIds.push(detail.itemId)\r\n          }else{\r\n            items.push(detail)\r\n            this.itemIds.push(detail.itemId)\r\n          }\r\n        }\r\n        // 获取产品列表\r\n        getProdAddedList({include:this.prodIds.join(',')}).then(res=>{\r\n          let data = res.data.data\r\n          let prods= {};\r\n          for(let prod of data){\r\n            prods[prod.id]=prod\r\n          }\r\n          for(let p of products){\r\n            p['prodName'] = prods[p.itemId].prodName\r\n            p['prodCode'] = prods[p.itemId].prodCode\r\n            p['prodDeptName'] = prods[p.itemId].prodDeptName\r\n            p['prodTypeName'] = prods[p.itemId].prodTypeName\r\n            p['releaseScopeName'] = prods[p.itemId].releaseScopeName\r\n            p['itemSourseName'] = prods[p.itemId].itemSourseName\r\n          }\r\n          this.form.prodInfo.products = products\r\n        })\r\n        // 获取产品项列表\r\n        getItemAddedList({include:this.itemIds.join(',')}).then(res=>{\r\n          let data = res.data.data\r\n          let its= {};\r\n          for(let it of data){\r\n            its[it.id]=it\r\n          }\r\n          console.log(items)\r\n          for(let item of items){\r\n            item['propName'] = its[item.itemId].propName\r\n            item['propCode'] = its[item.itemId].propCode\r\n            item['propDeptName'] = its[item.itemId].propDeptName\r\n            item['cateIdName'] = its[item.itemId].cateIdName\r\n            item['prodIdName'] = its[item.itemId].prodIdName\r\n            item['releaseScopeName'] = its[item.itemId].releaseScopeName\r\n            item['itemSourseName'] = its[item.itemId].itemSourseName\r\n          }\r\n          console.log(items)\r\n          this.form.itemInfo.items = items\r\n        })\r\n      })\r\n    },\r\n    save(prodState) {\r\n      this.loading = true;\r\n      console.log(prodState)\r\n      let validForms = [];\r\n      // let _this = this;\r\n      validForms.push({page:\"baseInfo\", formName:'draftForm'})\r\n      if(prodState < 4 || prodState ==5){\r\n        validForms.push(\r\n          {page:\"baseInfo\", formName:'baseForm'},\r\n          {page:\"prodInfo\", formName:'prodForm'},\r\n          {page:\"itemInfo\", formName:'itemForm'},\r\n          {page:\"rebateInfo\", formName:'rebateForm'}\r\n        )\r\n      }\r\n      Promise.all(\r\n        validForms.map(({page,formName}) => {\r\n            return this.$refs[page].$refs[formName].validate();\r\n        })\r\n      ).then(() => {\r\n        // 校验通过\r\n        // 校验产品信息\r\n        if(prodState!=4){\r\n          if(!this.form.prodInfo || this.form.prodInfo.products.length ==0){\r\n            this.$message({ type: \"warning\", message: \"请添加产品信息!\" });\r\n            return false;\r\n          }\r\n          if(!this.checekProds(this.form.prodInfo.products)){\r\n            this.$message({\r\n              type: \"warning\",\r\n              message: \"产品信息存在完全一致的数据，请核对!\"\r\n            });\r\n            return false;\r\n          }\r\n          \r\n          // 校验产品项信息\r\n          if(!this.form.itemInfo || this.form.itemInfo.items.length ==0){\r\n            this.$message({ type: \"warning\", message: \"请添加产品项信息!\" });\r\n            return false;\r\n          }\r\n          if(!this.checekProds(this.form.itemInfo.items)){\r\n            this.$message({\r\n              type: \"warning\",\r\n              message: \"产品项存在完全一致的数据，请核对!\"\r\n            });\r\n            return false;\r\n          }\r\n        }\r\n        \r\n        // 组合数据进行保存/修改\r\n        let params = Object.assign(this.form.baseInfo,{groupDetails:this.form.itemInfo.items.concat(this.form.prodInfo.products)})\r\n        if(prodState!=5){\r\n          params.prodState = prodState;\r\n        }\r\n       \r\n        console.log(123,params);\r\n        if(this.id){\r\n          update(params).then(res => {\r\n            this.loading = false;\r\n            this.$message.success(res.data.msg);\r\n            this.goBack();\r\n          });\r\n        }else{\r\n          add(params).then(res => {\r\n            this.loading = false;\r\n            this.$message.success(res.data.msg);\r\n            this.goBack();\r\n          });\r\n        }\r\n       \r\n      }).catch(() => {\r\n        //校验失败\r\n        console.log(\"error\");\r\n        this.loading = false;\r\n      })\r\n    },\r\n    checekProds(list){\r\n      let prodStr=\"|\";\r\n      for(let prod of list){\r\n        let infoStr = JSON.stringify(prod);\r\n        if(prodStr != '|' && prodStr.includes('|'+infoStr+'|')){\r\n          \r\n          return false;\r\n        }else{\r\n          prodStr += infoStr+'|'\r\n        }\r\n      }\r\n      return true;\r\n    },\r\n    goBack() {\r\n      this.$emit(\"back\");\r\n      // this.$router.go(-1);\r\n    }\r\n  }\r\n}\r\n</script>\r\n<style >\r\n  .header .el-page-header__content {\r\n    font-size: 14px;\r\n    font-weight: 500;\r\n    color: #303133;\r\n  }\r\n</style>"]}]}