{"remainingRequest":"F:\\东方通\\source\\b_zwj\\xinhua-finance-web\\node_modules\\vue-loader\\lib\\index.js??vue-loader-options!F:\\东方通\\source\\b_zwj\\xinhua-finance-web\\src\\views\\contract\\product\\product\\product-add.vue?vue&type=style&index=0&lang=css&","dependencies":[{"path":"F:\\东方通\\source\\b_zwj\\xinhua-finance-web\\src\\views\\contract\\product\\product\\product-add.vue","mtime":1618541026428},{"path":"F:\\东方通\\source\\b_zwj\\xinhua-finance-web\\node_modules\\css-loader\\index.js","mtime":499162500000},{"path":"F:\\东方通\\source\\b_zwj\\xinhua-finance-web\\node_modules\\vue-loader\\lib\\loaders\\stylePostLoader.js","mtime":499162500000},{"path":"F:\\东方通\\source\\b_zwj\\xinhua-finance-web\\node_modules\\postcss-loader\\src\\index.js","mtime":499162500000},{"path":"F:\\东方通\\source\\b_zwj\\xinhua-finance-web\\node_modules\\cache-loader\\dist\\cjs.js","mtime":499162500000},{"path":"F:\\东方通\\source\\b_zwj\\xinhua-finance-web\\node_modules\\vue-loader\\lib\\index.js","mtime":499162500000}],"contextDependencies":[],"result":["\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n.header .el-page-header__content {\n  font-size: 14px;\n  font-weight: 500;\n  color: #303133;\n}\n",{"version":3,"sources":["product-add.vue"],"names":[],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AA6OA;AACA;AACA;AACA;AACA","file":"product-add.vue","sourceRoot":"src/views/contract/product/product","sourcesContent":["<template>\r\n  <basic-container>\r\n    <template>\r\n      <el-row>\r\n        <el-col :span=\"16\">\r\n          <el-page-header @back=\"goBack\" :content=\"title\" class=\"header\">\r\n          </el-page-header>\r\n        </el-col>\r\n        <el-col :span=\"8\">\r\n          <el-row v-if=\"!isView\" style='float:right'>\r\n            <el-button size=\"small\" v-if=\"!btnState\" type=\"primary\" @click.native=\"save(4)\">保存至草稿</el-button>\r\n            <el-button size=\"small\" v-if=\"!btnState\" @click.native=\"save(3)\">保存暂不上架</el-button>\r\n            <el-button size=\"small\" v-if=\"!btnState\" type=\"primary\" @click.native=\"save(1)\">保存并上架</el-button>\r\n            <el-button size=\"small\" v-if=\"btnState\"  type=\"primary\" @click.native=\"save(5)\">保存</el-button>\r\n          </el-row>\r\n        </el-col>\r\n      </el-row>\r\n    </template>\r\n    <template>\r\n      <el-tabs v-model=\"activeName\" @tab-click=\"handleClick\">\r\n        <el-tab-pane label=\"基础信息\" name=\"baseInfo\">\r\n          <baseInfo ref=\"baseInfo\" :baseInfo=\"form.baseInfo\" :is-view=\"isView\"></baseInfo>\r\n        </el-tab-pane>\r\n        <el-tab-pane label=\"图文信息\" name=\"picInfo\" >\r\n          <pic-info ref=\"picInfo\" :picInfo=\"form.picInfo\" :is-view=\"isView\"></pic-info>\r\n        </el-tab-pane>\r\n        <el-tab-pane label=\"计价设置\" name=\"priceInfo\">\r\n          <priceInfo ref=\"priceInfo\" :priceInfo=\"form.priceInfo\" :is-view=\"isView\"></priceInfo>\r\n        </el-tab-pane>\r\n        <el-tab-pane label=\"分润信息\" name=\"profitInfo\">\r\n          <profitInfo ref=\"profitInfo\" :profitInfo=\"form.profitInfo\" :is-view=\"isView\"></profitInfo>\r\n        </el-tab-pane>\r\n      </el-tabs>\r\n    </template>\r\n  </basic-container>\r\n</template>\r\n<script>\r\nimport {add,getDetail,update} from \"@/api/contract/product/product\";\r\nimport baseInfo from \"./baseInfo\"\r\nimport profitInfo from \"../components/profitInfo\";\r\nimport picInfo from \"../components/picInfo\";\r\nimport priceInfo from \"../components/priceInfo\";\r\n\r\nexport default {\r\n  name:\"product-add\",\r\n  components:{baseInfo,priceInfo,picInfo,profitInfo},\r\n  props:{\r\n    id:'',\r\n    title:\"新增\",\r\n    isView:false\r\n  },\r\n  data(){\r\n    return {\r\n      activeName: 'baseInfo',\r\n      headers:{},\r\n      loading:false,\r\n      btnState:false,\r\n      picFiles:[],\r\n      form:{\r\n        baseInfo:{\r\n          prodCode: '',\r\n          prodName: '',\r\n          propDept: '',\r\n          prodType: '',\r\n          releaseScope: '',\r\n          addedDate: '',\r\n          expiredDate: '',\r\n          prodState:''\r\n        },\r\n        priceInfo:{\r\n          isValuation:2,\r\n          valuation:[]\r\n        },\r\n        picInfo:{\r\n          prodDesc:'',\r\n          itemDesc:'',\r\n          proImage:'',\r\n          fileLists:[],\r\n          dialogImageUrl: '',\r\n          dialogVisible: false\r\n        },\r\n        profitInfo:{\r\n          partnerId:'',\r\n          profitRates:[],\r\n          itemSourse: 1,\r\n          shareType: '',\r\n          shareResult:'' \r\n        }\r\n      }\r\n    }\r\n  },\r\n  mounted() {\r\n    this.$refs['priceInfo'].productType=1;\r\n    this.$refs['picInfo'].productType=1;\r\n    this.$refs['profitInfo'].productType=1;\r\n    if(this.id){\r\n      if(this.isView){\r\n        this.title=\"详情\";\r\n      }else{\r\n        this.title=\"编辑\";\r\n      }\r\n      this.detail();\r\n    }else{\r\n      this.title=\"新增\";\r\n    }\r\n  },\r\n  methods: {\r\n    detail(){\r\n      let _this = this\r\n      this.loading = true;\r\n      getDetail(_this.id).then(res =>{\r\n        console.log(res.data.data)\r\n        this.loading = false;\r\n        if(res.data.data){\r\n          if(res.data.data.prodState == 1){\r\n            this.btnState =true;\r\n          }\r\n          res.data.data.itemDesc = res.data.data.prodDesc\r\n          _this.$refs[\"baseInfo\"].showData(res.data.data);\r\n          _this.$refs[\"priceInfo\"].showData(res.data.data);\r\n          _this.$refs[\"picInfo\"].showData(res.data.data);\r\n          _this.$refs[\"profitInfo\"].showData(res.data.data);\r\n        }\r\n      })\r\n    },\r\n    save(prodState) {\r\n      let validForms = [];\r\n      let _this = this;\r\n      validForms.push({page:\"baseInfo\", formName:'draftForm'})\r\n      if(prodState < 4 || prodState ==5){\r\n        validForms.push(\r\n            {page:\"baseInfo\", formName:'baseForm'},\r\n            {page:\"priceInfo\", formName:'priceForm'},\r\n            {page:\"priceInfo\", formName:'inServForm'},\r\n            {page:\"profitInfo\", formName:'profitForm'})\r\n        if(this.$refs['profitInfo'].$refs['ratesForm']){\r\n          //保存暂不上架和保存并上架校验全部表单\r\n          //阶梯比例表单没显示时不校验该表单\r\n          validForms.push({page:\"profitInfo\",formName:\"ratesForm\"})\r\n        }\r\n      }\r\n      Promise.all(\r\n        validForms.map(({page,formName}) => {\r\n            return this.$refs[page].$refs[formName].validate();\r\n        })\r\n      ).then(() => {\r\n        if(_this.form.picInfo.fileLists){\r\n          _this.form.picInfo.fileLists.forEach(file =>{\r\n            if(file.id){\r\n              this.picFiles.push({imageUrl:file.url, fileName:file.name, fileSize:file.fileSize});\r\n            }else{\r\n              let data = file.response.data;\r\n              this.picFiles.push({imageUrl:data.link,fileName:data.originalName,fileSize:file.size});\r\n            }\r\n          })\r\n          _this.form.picInfo.fileList = this.picFiles;\r\n        }\r\n        if(_this.form.priceInfo && _this.form.priceInfo.isValuation ==1){ // 存在计价属性\r\n          let priceInfoStr=\"|\";\r\n          _this.form.priceInfo.valuations = [];\r\n          for(let info of _this.form.priceInfo.valuation){\r\n            // 判断是否都为空 为空则不存入数据库\r\n            let b = true; // 为false 说明全部为空 从列表中删除 ;true 不为空 \r\n            if(info.currency =='' && info.standardPrice =='' && info.promotionPrice ==''){// 三个常列为空\r\n              b=false\r\n              if(info.valuationValue.length != 0){ // // 有扩展列\r\n                for(var i=0; i<info.valuationValue.length; i++){\r\n                  if(info.valuationValue[i].propValue != ''){ // 扩展列有值\r\n                    b=true\r\n                    break;\r\n                  }\r\n                }\r\n              }\r\n            }\r\n            if(b){\r\n              // 判断当前\r\n              let infoStr = JSON.stringify(info);\r\n              console.log(priceInfoStr,priceInfoStr.includes('|'+infoStr+'|'))\r\n              if(priceInfoStr != '|' && priceInfoStr.includes('|'+infoStr+'|')){\r\n                this.$message({\r\n                  type: \"warning\",\r\n                  message: \"计价属性存在完全一致的数据，请核对!\"\r\n                });\r\n                return false;\r\n              }else{\r\n                priceInfoStr += infoStr+'|'\r\n                _this.form.priceInfo.valuations.push({\r\n                  valuationValues:JSON.stringify(info.valuationValue),\r\n                  currency: info.currency,\r\n                  promotionPrice: info.promotionPrice,\r\n                  standardPrice: info.promotionPrice\r\n                })\r\n              }\r\n            }\r\n          }\r\n          if(_this.form.priceInfo.valuations.length<=0){\r\n            this.$message({\r\n              type: \"warning\",\r\n              message: \"请最少输入一条计价信息!\"\r\n            });\r\n            return false;\r\n          }\r\n        }\r\n        _this.form.picInfo.prodDesc = _this.form.picInfo.itemDesc\r\n        let params = {..._this.form.baseInfo, ..._this.form.priceInfo,\r\n         ..._this.form.picInfo, ..._this.form.profitInfo}\r\n        if(prodState!=5){\r\n          params.prodState = prodState;\r\n        }\r\n        this.loading = true;\r\n        console.log(123,params);\r\n        if(this.id){\r\n          update(params).then(res => {\r\n            this.loading = false;\r\n            this.$message.success(res.data.msg);\r\n            this.goBack();\r\n          });\r\n        }else{\r\n          add(params).then(res => {\r\n            this.loading = false;\r\n            this.$message.success(res.data.msg);\r\n            this.goBack();\r\n          });\r\n        }\r\n      }).catch(() => {\r\n        //校验失败\r\n        console.log(\"error\");\r\n      })\r\n    },\r\n    goBack() {\r\n      this.$emit(\"back\");\r\n      // this.$router.go(-1);\r\n    }\r\n  }\r\n}\r\n</script>\r\n<style >\r\n  .header .el-page-header__content {\r\n    font-size: 14px;\r\n    font-weight: 500;\r\n    color: #303133;\r\n  }\r\n</style>"]}]}