{"remainingRequest":"F:\\东方通\\source\\b_zwj\\xinhua-finance-web\\node_modules\\vue-loader\\lib\\index.js??vue-loader-options!F:\\东方通\\source\\b_zwj\\xinhua-finance-web\\src\\views\\contract\\product\\components\\priceInfo.vue?vue&type=style&index=0&id=8d63009e&lang=scss&scoped=true&","dependencies":[{"path":"F:\\东方通\\source\\b_zwj\\xinhua-finance-web\\src\\views\\contract\\product\\components\\priceInfo.vue","mtime":1618794737782},{"path":"F:\\东方通\\source\\b_zwj\\xinhua-finance-web\\node_modules\\css-loader\\index.js","mtime":499162500000},{"path":"F:\\东方通\\source\\b_zwj\\xinhua-finance-web\\node_modules\\vue-loader\\lib\\loaders\\stylePostLoader.js","mtime":499162500000},{"path":"F:\\东方通\\source\\b_zwj\\xinhua-finance-web\\node_modules\\postcss-loader\\src\\index.js","mtime":499162500000},{"path":"F:\\东方通\\source\\b_zwj\\xinhua-finance-web\\node_modules\\sass-loader\\dist\\cjs.js","mtime":499162500000},{"path":"F:\\东方通\\source\\b_zwj\\xinhua-finance-web\\node_modules\\cache-loader\\dist\\cjs.js","mtime":499162500000},{"path":"F:\\东方通\\source\\b_zwj\\xinhua-finance-web\\node_modules\\vue-loader\\lib\\index.js","mtime":499162500000}],"contextDependencies":[],"result":["\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\r\n.add-btn{\r\n  margin-bottom: 1rem;\r\n}\r\n.table-tip{\r\n  color: #F56C6C;\r\n  font-weight: normal;\r\n  vertical-align: middle;\r\n  margin-right: 2px;\r\n  font-size: 14px;\r\n}\r\n.normal-input{\r\n  margin-bottom: 18px;\r\n}\r\n",{"version":3,"sources":["priceInfo.vue"],"names":[],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AA8PA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA","file":"priceInfo.vue","sourceRoot":"src/views/contract/product/components","sourcesContent":["<template>\r\n  <el-form ref=\"priceForm\" :model=\"priceInfo\" label-width=\"100px\" class=\"demo-form-inline\"  size=\"mini\">\r\n    <el-form-item label=\"是否计价\">\r\n      <el-radio-group :disabled=\"isView\" v-model=\"priceInfo.isValuation\" @change=\"valuationChange\">\r\n        <el-radio :label=\"1\">是</el-radio>\r\n        <el-radio :label=\"2\">否</el-radio>\r\n      </el-radio-group>\r\n    </el-form-item>\r\n    <el-form-item label=\"计价方式\" v-show=\"priceInfo.isValuation==1\">\r\n      <el-button type=\"primary\" v-if=\"!isView\" size=\"small\" @click=\"openDialog\" class=\"add-btn\">添加计价属性</el-button>\r\n      <template>\r\n         <el-form \r\n          :model=\"priceInfo\" \r\n          ref=\"inServForm\"\r\n          size=\"small\">\r\n          <el-table border size=\"small\"\r\n            :data=\"priceInfo.valuation\">\r\n            <el-table-column v-for=\"(item, i) in itemColumns\" :key='item.id' prop=\"propValue\" :label=\"item.propName\">\r\n              <template slot=\"header\" slot-scope=\"scope\">\r\n                <span><i v-if=\"item.isRequired==1\" class=\"table-tip\">*</i>{{item.propName}}</span><i v-if=\"!isView\" style=\"float: right; color: #F56C6C;\" class=\"el-icon-remove-outline\" @click=\"rmPriceColumn(item)\"></i>   \r\n              </template>\r\n              <template slot-scope=\"scope\">\r\n                  <el-form-item \r\n                  :rules=\"[{ required:item.isRequired==1?true:false,message:item.showType == 1?`请输入${item.propName}`:`请选择${item.propName}`,trigger:item.showType == 1?'blur':'change'}]\"\r\n                  :prop=\"'valuation.' + scope.$index +'.valuationValue.'+i+'.propValue'\">\r\n                    <el-input :disabled=\"isView\" v-model=\"scope.row.valuationValue[i].propValue\" placeholder=\"请输入\" size=\"mini\" v-if=\"item.showType == 1\" ></el-input>\r\n                    <el-select :disabled=\"isView\" style=\"width:100%\" size=\"mini\" v-model=\"scope.row.valuationValue[i].propValue\" placeholder=\"请选择\"  v-if=\"item.showType == 2\">\r\n                      <el-option v-for=\"(im,t) in item.options\" :key=\"t\" :label=\"im.propValue\" :value=\"im.propValue\"></el-option>\r\n                    </el-select>\r\n                  </el-form-item>\r\n              </template>\r\n            </el-table-column>\r\n            <el-table-column label=\"标准价\">\r\n              <template slot=\"header\" slot-scope=\"scope\">\r\n                <span><i class=\"table-tip\">*</i>标准价</span>   \r\n              </template>\r\n              <template slot-scope=\"scope\">\r\n                <el-form-item \r\n                :prop=\"'valuation.' + scope.$index + '.standardPrice'\"\r\n                :rules=\"[{required:true,message:'请输入标准价',trigger:'blur'}]\">\r\n                  <el-input :disabled=\"isView\" type=\"number\" v-model=\"scope.row.standardPrice\" ></el-input>\r\n                </el-form-item>\r\n              </template>\r\n            </el-table-column>\r\n            <el-table-column label=\"促销价\">\r\n              <template slot-scope=\"scope\">\r\n                <el-input :disabled=\"isView\" type=\"number\" v-model=\"scope.row.promotionPrice\"  class=\"normal-input\"></el-input>\r\n              </template>\r\n            </el-table-column>\r\n            <el-table-column label=\"币种\" >\r\n              <template slot=\"header\" slot-scope=\"scope\">\r\n                <span><i class=\"table-tip\">*</i>币种</span>   \r\n              </template>\r\n              <template slot-scope=\"scope\">\r\n                <el-form-item \r\n                  :prop=\"'valuation.' + scope.$index + '.currency'\"\r\n                  :rules=\"[{required:true,message:'请选择标币种',trigger:'blur'}]\">\r\n                  <el-select :disabled=\"isView\" v-model=\"scope.row.currency\" filterable placeholder=\"请选择\">\r\n                    <el-option v-for=\"(item,i) in currencyTypes\" :key=\"i\" :label=\"item.dictValue\" :value=\"item.dictKey\"></el-option>\r\n                  </el-select>\r\n                </el-form-item>\r\n              </template>\r\n            </el-table-column>\r\n            <el-table-column v-if=\"!isView\" label=\"操作\" fixed=\"right\" width=\"80\">\r\n              <template slot-scope=\"scope\">\r\n                  <el-button v-if=\"scope.$index == 0\" icon=\"el-icon-circle-plus-outline\" type=\"text\" size=\"small\" @click=\"priceInfoAddRow(scope.$index, scope.row)\">新增</el-button>\r\n                  <el-button v-if=\"scope.$index > 0\" icon=\"el-icon-delete\" type=\"text\" size=\"small\" style='color: #E02020;' @click=\"priceInfoRmRow(scope.$index, scope.row)\">删除</el-button>\r\n              </template>\r\n            </el-table-column>\r\n          </el-table>\r\n          </el-form>\r\n      </template>\r\n    </el-form-item>\r\n    <price-pro-dialog dialogTitle=\"添加计价属性\" :dialogForm=\"dialogForm\" :proDialog=\"openPriceDialog\" @resultPrice=\"priceAddColumn\" @cancelPrice=\"cancelPriceDialog\"></price-pro-dialog>\r\n  </el-form>\r\n</template>\r\n<script>\r\nimport priceProDialog from \"./priceProDialog\";\r\nimport {getDictByCode} from \"@/api/system/dict\";\r\nimport {getValuations} from \"@/api/contract/product/productitem\";\r\nimport { getListByCate} from \"@/api/contract/product/property\";\r\nimport bus from '@/assets/js/event-bus';\r\nexport default {\r\n  components:{priceProDialog},\r\n  name:\"priceInfo\",\r\n  props:{\r\n    isView:false,\r\n    priceInfo:{\r\n    }\r\n  },\r\n  data(){\r\n      return {\r\n        dialogForm:{\r\n          productType:1,// 1产品类型；2产品项；3组成产品；\r\n          propType:1,\r\n          exclude:'',\r\n          include:'',\r\n        },\r\n        cateId:'',\r\n        itemColumns:[],\r\n        excludeIds:[],\r\n        includeIds:[],\r\n        currencyTypes:[],\r\n        openPriceDialog:false,\r\n      }\r\n  },\r\n  mounted(){\r\n    this.onLoad()\r\n    bus.$on('cateIdBus',data =>{\r\n      this.cateId = data\r\n      this.priceInfo.isValuation=2\r\n      this.valuationChange(this.priceInfo.isValuation)\r\n    })\r\n  },\r\n  methods:{\r\n    showData(data){\r\n      let _this = this;\r\n      this.priceInfo.isValuation = data.isValuation;\r\n      this.$forceUpdate()\r\n      getValuations({prodId:data.id, type:this.productType}).then(res =>{\r\n        data = res.data.data\r\n        console.log(\"price\",data)\r\n        data.forEach((item ,i)=>{\r\n          if(i==0){\r\n            JSON.parse(item.valuationValues).forEach(column=>{\r\n              _this.includeIds.push(column.propId)\r\n              _this.excludeIds.push(column.propId)\r\n            })\r\n          }\r\n          this.priceInfo.valuation.push({\r\n            valuationValue:JSON.parse(item.valuationValues),\r\n            standardPrice:item.standardPrice,\r\n            promotionPrice:item.promotionPrice,\r\n            currency:item.currency\r\n          });\r\n        })\r\n        this.dialogForm.include = _this.includeIds.join(',');\r\n        getListByCate(this.dialogForm).then(res =>{\r\n          let column={}\r\n          res.data.data.forEach(item=>{\r\n            column[item.id]=item\r\n          })\r\n          _this.includeIds.forEach(id =>{\r\n            if(column[id]){\r\n              this.itemColumns.push(column[id])\r\n            }\r\n          })\r\n          this.dialogForm.include='';\r\n          console.log(1255,this.itemColumns)\r\n        })\r\n        this.dialogForm.exclude = _this.excludeIds.join(',');\r\n      })\r\n    },\r\n    valuationChange(value){\r\n      if(value==1){ // 是否计价 是\r\n        this.priceInfo.valuation=[{\r\n          valuationValue:this.handleColumns(),\r\n          standardPrice:'',\r\n          promotionPrice:'',\r\n          currency:''\r\n        }];\r\n        if(this.cateId !=''){// // 产品项 需要重新将选择属性的计价属性带出来\r\n          getListByCate({propType:this.dialogForm.propType,cateId:this.cateId}).then(res => {\r\n            const data = res.data.data;\r\n            this.priceAddColumn(data)\r\n          });\r\n        }\r\n      }else if(value==2){ // 否\r\n        this.priceInfo.valuation=[]\r\n        this.itemColumns=[]\r\n        this.excludeIds=[]\r\n        this.dialogForm.exclude=''\r\n      }\r\n    },\r\n    onLoad(){\r\n      getDictByCode(this.CONSTANT.CURRENCY_TYPE).then(res => {\r\n        this.currencyTypes=res.data.data\r\n      });\r\n    },\r\n    openDialog(){\r\n      if(this.productType == 2 && this.dialogForm.cateId ==''){\r\n        this.$message.warning('请先选择产品类型');\r\n      }else{\r\n        this.openPriceDialog = true\r\n      }\r\n    },\r\n    cancelPriceDialog(){\r\n      this.openPriceDialog = false\r\n    },\r\n    rmPriceColumn(item){\r\n      this.itemColumns.splice(this.itemColumns.findIndex(_ => {\r\n          return _.id === item.id\r\n       }), 1);\r\n      this.excludeIds.splice(this.excludeIds.findIndex(_ => {\r\n          return _.id === item.id\r\n       }), 1);\r\n      this.dialogForm.exclude = this.excludeIds.join(',');\r\n      // 删除 已经添加的行数\r\n      this.priceInfo.valuation.forEach(val =>{\r\n        val.valuationValue.splice(this.itemColumns.findIndex(_ => {\r\n          return _.id === item.id\r\n        }), 1);\r\n      })\r\n    },\r\n    // 添加列\r\n    priceAddColumn(data) {\r\n      this.itemColumns.push(...data)\r\n      data.forEach(item =>{\r\n        this.excludeIds.push(item.id);\r\n        this.priceInfo.valuation.forEach(val =>{\r\n          val.valuationValue.push({\r\n            propId:item.id,\r\n            propCode:item.propCode,\r\n            propName:item.propName,\r\n            propValue:''\r\n          })\r\n        })\r\n      })\r\n      this.dialogForm.exclude = this.excludeIds.join(',');\r\n      this.openPriceDialog = false;\r\n      console.log('add-column',this.priceInfo.valuation)\r\n    },\r\n    // 处理列数据\r\n    handleColumns(){\r\n      let columns=[]\r\n      this.itemColumns.forEach(item=>{\r\n        columns.push({\r\n          propId:item.id,\r\n          propCode:item.propCode,\r\n          propName:item.propName,\r\n          propValue:''\r\n        })\r\n      })\r\n      return columns\r\n    },\r\n    priceInfoAddRow(){\r\n      \r\n      this.priceInfo.valuation.push({\r\n        valuationValue:this.handleColumns(),\r\n        standardPrice:'',\r\n        promotionPrice:'',\r\n        currency:''\r\n      });\r\n      console.log('add-row',this.priceInfo.valuation)\r\n    },\r\n    priceInfoRmRow(index){\r\n      this.priceInfo.valuation.splice(index, 1);\r\n      this.excludeIds.splice(index, 1);\r\n      this.dialogForm.exclude = this.excludeIds.join(',');\r\n    },\r\n  }\r\n}\r\n</script>\r\n<style lang=\"scss\" scoped>\r\n.add-btn{\r\n  margin-bottom: 1rem;\r\n}\r\n.table-tip{\r\n  color: #F56C6C;\r\n  font-weight: normal;\r\n  vertical-align: middle;\r\n  margin-right: 2px;\r\n  font-size: 14px;\r\n}\r\n.normal-input{\r\n  margin-bottom: 18px;\r\n}\r\n</style>"]}]}