{"remainingRequest":"F:\\东方通\\source\\b_zwj\\xinhua-finance-web\\node_modules\\babel-loader\\lib\\index.js!F:\\东方通\\source\\b_zwj\\xinhua-finance-web\\node_modules\\cache-loader\\dist\\cjs.js??ref--0-0!F:\\东方通\\source\\b_zwj\\xinhua-finance-web\\node_modules\\vue-loader\\lib\\index.js??vue-loader-options!F:\\东方通\\source\\b_zwj\\xinhua-finance-web\\src\\views\\contract\\product\\group\\group-add.vue?vue&type=script&lang=js&","dependencies":[{"path":"F:\\东方通\\source\\b_zwj\\xinhua-finance-web\\src\\views\\contract\\product\\group\\group-add.vue","mtime":1618541026422},{"path":"F:\\东方通\\source\\b_zwj\\xinhua-finance-web\\node_modules\\cache-loader\\dist\\cjs.js","mtime":499162500000},{"path":"F:\\东方通\\source\\b_zwj\\xinhua-finance-web\\node_modules\\babel-loader\\lib\\index.js","mtime":315532800000},{"path":"F:\\东方通\\source\\b_zwj\\xinhua-finance-web\\node_modules\\cache-loader\\dist\\cjs.js","mtime":499162500000},{"path":"F:\\东方通\\source\\b_zwj\\xinhua-finance-web\\node_modules\\vue-loader\\lib\\index.js","mtime":499162500000}],"contextDependencies":[],"result":["import \"core-js/modules/es7.symbol.async-iterator\";\nimport \"core-js/modules/es6.symbol\";\nimport \"core-js/modules/es6.array.from\";\nimport \"core-js/modules/es6.function.name\";\nimport \"core-js/modules/es6.regexp.to-string\";\nimport \"core-js/modules/es7.array.includes\";\nimport \"core-js/modules/es6.string.includes\";\nimport \"core-js/modules/web.dom.iterable\";\nimport \"core-js/modules/es6.string.iterator\";\n\nfunction _createForOfIteratorHelper(o, allowArrayLike) { var it; if (typeof Symbol === \"undefined\" || o[Symbol.iterator] == null) { if (Array.isArray(o) || (it = _unsupportedIterableToArray(o)) || allowArrayLike && o && typeof o.length === \"number\") { if (it) o = it; var i = 0; var F = function F() {}; return { s: F, n: function n() { if (i >= o.length) return { done: true }; return { done: false, value: o[i++] }; }, e: function e(_e) { throw _e; }, f: F }; } throw new TypeError(\"Invalid attempt to iterate non-iterable instance.\\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.\"); } var normalCompletion = true, didErr = false, err; return { s: function s() { it = o[Symbol.iterator](); }, n: function n() { var step = it.next(); normalCompletion = step.done; return step; }, e: function e(_e2) { didErr = true; err = _e2; }, f: function f() { try { if (!normalCompletion && it.return != null) it.return(); } finally { if (didErr) throw err; } } }; }\n\nfunction _unsupportedIterableToArray(o, minLen) { if (!o) return; if (typeof o === \"string\") return _arrayLikeToArray(o, minLen); var n = Object.prototype.toString.call(o).slice(8, -1); if (n === \"Object\" && o.constructor) n = o.constructor.name; if (n === \"Map\" || n === \"Set\") return Array.from(o); if (n === \"Arguments\" || /^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)) return _arrayLikeToArray(o, minLen); }\n\nfunction _arrayLikeToArray(arr, len) { if (len == null || len > arr.length) len = arr.length; for (var i = 0, arr2 = new Array(len); i < len; i++) { arr2[i] = arr[i]; } return arr2; }\n\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\nimport { add, getDetail, update } from \"@/api/contract/product/group\";\nimport { getProdAddedList } from \"@/api/contract/product/product\";\nimport { getItemAddedList } from \"@/api/contract/product/productitem\";\nimport baseInfo from \"./baseInfo\";\nimport rebateInfo from \"./rebateInfo\";\nimport prodInfo from \"./prodInfo\";\nimport itemInfo from \"./itemInfo\";\nexport default {\n  name: \"product-add\",\n  components: {\n    baseInfo: baseInfo,\n    prodInfo: prodInfo,\n    itemInfo: itemInfo,\n    rebateInfo: rebateInfo\n  },\n  props: {\n    id: '',\n    title: \"新增\",\n    isView: false\n  },\n  data: function data() {\n    return {\n      activeName: 'baseInfo',\n      headers: {},\n      loading: false,\n      btnState: false,\n      picFiles: [],\n      prodIds: [],\n      itemIds: [],\n      form: {\n        baseInfo: {\n          id: '',\n          prodName: '',\n          propDept: '',\n          addedDate: '',\n          expiredDate: '',\n          discount: '',\n          prodState: ''\n        },\n        prodInfo: {\n          products: []\n        },\n        itemInfo: {\n          items: []\n        }\n      }\n    };\n  },\n  mounted: function mounted() {\n    if (this.id) {\n      if (this.isView) {\n        this.title = \"详情\";\n      } else {\n        this.title = \"编辑\";\n      }\n\n      this.detail();\n    } else {\n      this.title = \"新增\";\n    }\n  },\n  methods: {\n    detail: function detail() {\n      var _this2 = this;\n\n      var _this = this;\n\n      this.loading = true;\n      getDetail(_this.id).then(function (res) {\n        var data = res.data.data;\n        _this2.form.baseInfo = data;\n        _this2.form.baseInfo.propDept = data.propDept ? data.propDept : '';\n\n        if (data.prodState == 1) {\n          _this2.btnState = true;\n        }\n\n        var detailList = data.detailList;\n        var products = [];\n        var items = [];\n\n        var _iterator = _createForOfIteratorHelper(detailList),\n            _step;\n\n        try {\n          for (_iterator.s(); !(_step = _iterator.n()).done;) {\n            var detail = _step.value;\n\n            if (detail.type == 1) {\n              // 1产品2产品项\n              products.push(detail);\n\n              _this2.prodIds.push(detail.itemId);\n            } else {\n              items.push(detail);\n\n              _this2.itemIds.push(detail.itemId);\n            }\n          } // 获取产品列表\n\n        } catch (err) {\n          _iterator.e(err);\n        } finally {\n          _iterator.f();\n        }\n\n        getProdAddedList({\n          include: _this2.prodIds.join(',')\n        }).then(function (res) {\n          var data = res.data.data;\n          var prods = {};\n\n          var _iterator2 = _createForOfIteratorHelper(data),\n              _step2;\n\n          try {\n            for (_iterator2.s(); !(_step2 = _iterator2.n()).done;) {\n              var prod = _step2.value;\n              prods[prod.id] = prod;\n            }\n          } catch (err) {\n            _iterator2.e(err);\n          } finally {\n            _iterator2.f();\n          }\n\n          var _iterator3 = _createForOfIteratorHelper(products),\n              _step3;\n\n          try {\n            for (_iterator3.s(); !(_step3 = _iterator3.n()).done;) {\n              var p = _step3.value;\n              p['prodName'] = prods[p.itemId].prodName;\n              p['prodCode'] = prods[p.itemId].prodCode;\n              p['prodDeptName'] = prods[p.itemId].prodDeptName;\n              p['prodTypeName'] = prods[p.itemId].prodTypeName;\n              p['releaseScopeName'] = prods[p.itemId].releaseScopeName;\n              p['itemSourseName'] = prods[p.itemId].itemSourseName;\n            }\n          } catch (err) {\n            _iterator3.e(err);\n          } finally {\n            _iterator3.f();\n          }\n\n          _this2.form.prodInfo.products = products;\n        }); // 获取产品项列表\n\n        getItemAddedList({\n          include: _this2.itemIds.join(',')\n        }).then(function (res) {\n          var data = res.data.data;\n          var its = {};\n\n          var _iterator4 = _createForOfIteratorHelper(data),\n              _step4;\n\n          try {\n            for (_iterator4.s(); !(_step4 = _iterator4.n()).done;) {\n              var it = _step4.value;\n              its[it.id] = it;\n            }\n          } catch (err) {\n            _iterator4.e(err);\n          } finally {\n            _iterator4.f();\n          }\n\n          console.log(items);\n\n          var _iterator5 = _createForOfIteratorHelper(items),\n              _step5;\n\n          try {\n            for (_iterator5.s(); !(_step5 = _iterator5.n()).done;) {\n              var item = _step5.value;\n              item['propName'] = its[item.itemId].propName;\n              item['propCode'] = its[item.itemId].propCode;\n              item['propDeptName'] = its[item.itemId].propDeptName;\n              item['cateIdName'] = its[item.itemId].cateIdName;\n              item['prodIdName'] = its[item.itemId].prodIdName;\n              item['releaseScopeName'] = its[item.itemId].releaseScopeName;\n              item['itemSourseName'] = its[item.itemId].itemSourseName;\n            }\n          } catch (err) {\n            _iterator5.e(err);\n          } finally {\n            _iterator5.f();\n          }\n\n          console.log(items);\n          _this2.form.itemInfo.items = items;\n        });\n      });\n    },\n    save: function save(prodState) {\n      var _this3 = this;\n\n      this.loading = true;\n      console.log(prodState);\n      var validForms = []; // let _this = this;\n\n      validForms.push({\n        page: \"baseInfo\",\n        formName: 'draftForm'\n      });\n\n      if (prodState < 4 || prodState == 5) {\n        validForms.push({\n          page: \"baseInfo\",\n          formName: 'baseForm'\n        }, {\n          page: \"prodInfo\",\n          formName: 'prodForm'\n        }, {\n          page: \"itemInfo\",\n          formName: 'itemForm'\n        }, {\n          page: \"rebateInfo\",\n          formName: 'rebateForm'\n        });\n      }\n\n      Promise.all(validForms.map(function (_ref) {\n        var page = _ref.page,\n            formName = _ref.formName;\n        return _this3.$refs[page].$refs[formName].validate();\n      })).then(function () {\n        // 校验通过\n        // 校验产品信息\n        if (prodState != 4) {\n          if (!_this3.form.prodInfo || _this3.form.prodInfo.products.length == 0) {\n            _this3.$message({\n              type: \"warning\",\n              message: \"请添加产品信息!\"\n            });\n\n            return false;\n          }\n\n          if (!_this3.checekProds(_this3.form.prodInfo.products)) {\n            _this3.$message({\n              type: \"warning\",\n              message: \"产品信息存在完全一致的数据，请核对!\"\n            });\n\n            return false;\n          } // 校验产品项信息\n\n\n          if (!_this3.form.itemInfo || _this3.form.itemInfo.items.length == 0) {\n            _this3.$message({\n              type: \"warning\",\n              message: \"请添加产品项信息!\"\n            });\n\n            return false;\n          }\n\n          if (!_this3.checekProds(_this3.form.itemInfo.items)) {\n            _this3.$message({\n              type: \"warning\",\n              message: \"产品项存在完全一致的数据，请核对!\"\n            });\n\n            return false;\n          }\n        } // 组合数据进行保存/修改\n\n\n        var params = Object.assign(_this3.form.baseInfo, {\n          groupDetails: _this3.form.itemInfo.items.concat(_this3.form.prodInfo.products)\n        });\n\n        if (prodState != 5) {\n          params.prodState = prodState;\n        }\n\n        console.log(123, params);\n\n        if (_this3.id) {\n          update(params).then(function (res) {\n            _this3.loading = false;\n\n            _this3.$message.success(res.data.msg);\n\n            _this3.goBack();\n          });\n        } else {\n          add(params).then(function (res) {\n            _this3.loading = false;\n\n            _this3.$message.success(res.data.msg);\n\n            _this3.goBack();\n          });\n        }\n      }).catch(function () {\n        //校验失败\n        console.log(\"error\");\n        _this3.loading = false;\n      });\n    },\n    checekProds: function checekProds(list) {\n      var prodStr = \"|\";\n\n      var _iterator6 = _createForOfIteratorHelper(list),\n          _step6;\n\n      try {\n        for (_iterator6.s(); !(_step6 = _iterator6.n()).done;) {\n          var prod = _step6.value;\n          var infoStr = JSON.stringify(prod);\n\n          if (prodStr != '|' && prodStr.includes('|' + infoStr + '|')) {\n            return false;\n          } else {\n            prodStr += infoStr + '|';\n          }\n        }\n      } catch (err) {\n        _iterator6.e(err);\n      } finally {\n        _iterator6.f();\n      }\n\n      return true;\n    },\n    goBack: function goBack() {\n      this.$emit(\"back\"); // this.$router.go(-1);\n    }\n  }\n};",{"version":3,"sources":["group-add.vue"],"names":[],"mappings":"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","sourcesContent":["<template>\r\n  <basic-container>\r\n    <template>\r\n      <el-row>\r\n        <el-col :span=\"16\">\r\n          <el-page-header @back=\"goBack\" :content=\"title\" class=\"header\">\r\n          </el-page-header>\r\n        </el-col>\r\n        <el-col :span=\"8\">\r\n          <el-row v-if=\"!isView\" style='float:right'>\r\n            <el-button size=\"small\" v-if=\"!btnState\" type=\"primary\" @click.native=\"save(4)\">保存至草稿</el-button>\r\n            <el-button size=\"small\" v-if=\"!btnState\"  @click.native=\"save(3)\">保存暂不上架</el-button>\r\n            <el-button size=\"small\" v-if=\"!btnState\" type=\"primary\" @click.native=\"save(1)\">保存并上架</el-button>\r\n            <el-button size=\"small\" v-if=\"btnState\" type=\"primary\" @click.native=\"save(5)\">保存</el-button>\r\n          </el-row>\r\n        </el-col>\r\n      </el-row>\r\n    </template>\r\n    <template>\r\n      <el-tabs v-model=\"activeName\" @tab-click=\"handleClick\">\r\n        <el-tab-pane label=\"基础信息\" name=\"baseInfo\">\r\n          <baseInfo ref=\"baseInfo\" :baseInfo=\"form.baseInfo\" :is-view=\"isView\"></baseInfo>\r\n        </el-tab-pane>\r\n        <el-tab-pane label=\"产品\" name=\"prodInfo\" >\r\n          <prodInfo ref=\"prodInfo\" :prodInfo=\"form.prodInfo\" :is-view=\"isView\"></prodInfo>\r\n        </el-tab-pane>\r\n        <el-tab-pane label=\"产品项\" name=\"priceInfo\">\r\n          <itemInfo ref=\"itemInfo\" :itemInfo=\"form.itemInfo\" :is-view=\"isView\"></itemInfo>\r\n        </el-tab-pane>\r\n        <el-tab-pane label=\"折扣信息\" name=\"profitInfo\">\r\n          <rebateInfo ref=\"rebateInfo\" :rebateInfo=\"form.baseInfo\" :is-view=\"isView\"></rebateInfo>\r\n        </el-tab-pane>\r\n      </el-tabs>\r\n    </template>\r\n  </basic-container>\r\n</template>\r\n<script>\r\nimport {add,getDetail,update} from \"@/api/contract/product/group\";\r\nimport {getProdAddedList} from \"@/api/contract/product/product\";\r\nimport {getItemAddedList} from \"@/api/contract/product/productitem\";\r\nimport baseInfo from \"./baseInfo\"\r\nimport rebateInfo from \"./rebateInfo\"\r\nimport prodInfo from \"./prodInfo\"\r\nimport itemInfo from \"./itemInfo\"\r\n\r\nexport default {\r\n  name:\"product-add\",\r\n  components:{baseInfo, prodInfo, itemInfo, rebateInfo},\r\n  props:{\r\n    id:'',\r\n    title:\"新增\",\r\n    isView:false\r\n  },\r\n  data(){\r\n    return {\r\n      activeName: 'baseInfo',\r\n      headers:{},\r\n      loading:false,\r\n      btnState:false,\r\n      picFiles:[],\r\n      prodIds:[],\r\n      itemIds:[],\r\n      form:{\r\n        baseInfo:{\r\n          id:'',\r\n          prodName: '',\r\n          propDept: '',\r\n          addedDate: '',\r\n          expiredDate: '',\r\n          discount:'',\r\n          prodState:''\r\n        },\r\n        prodInfo:{\r\n          products:[]\r\n        },\r\n        itemInfo:{\r\n          items:[]\r\n        }\r\n      }\r\n    }\r\n  },\r\n  mounted() {\r\n    if(this.id){\r\n      if(this.isView){\r\n        this.title=\"详情\";\r\n      }else{\r\n        this.title=\"编辑\";\r\n      }\r\n      this.detail();\r\n    }else{\r\n      this.title=\"新增\";\r\n    }\r\n  },\r\n  methods: {\r\n    detail(){\r\n      let _this = this\r\n      this.loading = true;\r\n      getDetail(_this.id).then(res =>{\r\n        let data = res.data.data;\r\n        this.form.baseInfo = data;\r\n        this.form.baseInfo.propDept = data.propDept?data.propDept:'';\r\n        if(data.prodState == 1){\r\n          this.btnState =true;\r\n        }\r\n        let detailList = data.detailList;\r\n        let products=[];\r\n        let items=[];\r\n        for(let detail of detailList){\r\n          if(detail.type == 1){// 1产品2产品项\r\n            products.push(detail)\r\n            this.prodIds.push(detail.itemId)\r\n          }else{\r\n            items.push(detail)\r\n            this.itemIds.push(detail.itemId)\r\n          }\r\n        }\r\n        // 获取产品列表\r\n        getProdAddedList({include:this.prodIds.join(',')}).then(res=>{\r\n          let data = res.data.data\r\n          let prods= {};\r\n          for(let prod of data){\r\n            prods[prod.id]=prod\r\n          }\r\n          for(let p of products){\r\n            p['prodName'] = prods[p.itemId].prodName\r\n            p['prodCode'] = prods[p.itemId].prodCode\r\n            p['prodDeptName'] = prods[p.itemId].prodDeptName\r\n            p['prodTypeName'] = prods[p.itemId].prodTypeName\r\n            p['releaseScopeName'] = prods[p.itemId].releaseScopeName\r\n            p['itemSourseName'] = prods[p.itemId].itemSourseName\r\n          }\r\n          this.form.prodInfo.products = products\r\n        })\r\n        // 获取产品项列表\r\n        getItemAddedList({include:this.itemIds.join(',')}).then(res=>{\r\n          let data = res.data.data\r\n          let its= {};\r\n          for(let it of data){\r\n            its[it.id]=it\r\n          }\r\n          console.log(items)\r\n          for(let item of items){\r\n            item['propName'] = its[item.itemId].propName\r\n            item['propCode'] = its[item.itemId].propCode\r\n            item['propDeptName'] = its[item.itemId].propDeptName\r\n            item['cateIdName'] = its[item.itemId].cateIdName\r\n            item['prodIdName'] = its[item.itemId].prodIdName\r\n            item['releaseScopeName'] = its[item.itemId].releaseScopeName\r\n            item['itemSourseName'] = its[item.itemId].itemSourseName\r\n          }\r\n          console.log(items)\r\n          this.form.itemInfo.items = items\r\n        })\r\n      })\r\n    },\r\n    save(prodState) {\r\n      this.loading = true;\r\n      console.log(prodState)\r\n      let validForms = [];\r\n      // let _this = this;\r\n      validForms.push({page:\"baseInfo\", formName:'draftForm'})\r\n      if(prodState < 4 || prodState ==5){\r\n        validForms.push(\r\n          {page:\"baseInfo\", formName:'baseForm'},\r\n          {page:\"prodInfo\", formName:'prodForm'},\r\n          {page:\"itemInfo\", formName:'itemForm'},\r\n          {page:\"rebateInfo\", formName:'rebateForm'}\r\n        )\r\n      }\r\n      Promise.all(\r\n        validForms.map(({page,formName}) => {\r\n            return this.$refs[page].$refs[formName].validate();\r\n        })\r\n      ).then(() => {\r\n        // 校验通过\r\n        // 校验产品信息\r\n        if(prodState!=4){\r\n          if(!this.form.prodInfo || this.form.prodInfo.products.length ==0){\r\n            this.$message({ type: \"warning\", message: \"请添加产品信息!\" });\r\n            return false;\r\n          }\r\n          if(!this.checekProds(this.form.prodInfo.products)){\r\n            this.$message({\r\n              type: \"warning\",\r\n              message: \"产品信息存在完全一致的数据，请核对!\"\r\n            });\r\n            return false;\r\n          }\r\n          \r\n          // 校验产品项信息\r\n          if(!this.form.itemInfo || this.form.itemInfo.items.length ==0){\r\n            this.$message({ type: \"warning\", message: \"请添加产品项信息!\" });\r\n            return false;\r\n          }\r\n          if(!this.checekProds(this.form.itemInfo.items)){\r\n            this.$message({\r\n              type: \"warning\",\r\n              message: \"产品项存在完全一致的数据，请核对!\"\r\n            });\r\n            return false;\r\n          }\r\n        }\r\n        \r\n        // 组合数据进行保存/修改\r\n        let params = Object.assign(this.form.baseInfo,{groupDetails:this.form.itemInfo.items.concat(this.form.prodInfo.products)})\r\n        if(prodState!=5){\r\n          params.prodState = prodState;\r\n        }\r\n       \r\n        console.log(123,params);\r\n        if(this.id){\r\n          update(params).then(res => {\r\n            this.loading = false;\r\n            this.$message.success(res.data.msg);\r\n            this.goBack();\r\n          });\r\n        }else{\r\n          add(params).then(res => {\r\n            this.loading = false;\r\n            this.$message.success(res.data.msg);\r\n            this.goBack();\r\n          });\r\n        }\r\n       \r\n      }).catch(() => {\r\n        //校验失败\r\n        console.log(\"error\");\r\n        this.loading = false;\r\n      })\r\n    },\r\n    checekProds(list){\r\n      let prodStr=\"|\";\r\n      for(let prod of list){\r\n        let infoStr = JSON.stringify(prod);\r\n        if(prodStr != '|' && prodStr.includes('|'+infoStr+'|')){\r\n          \r\n          return false;\r\n        }else{\r\n          prodStr += infoStr+'|'\r\n        }\r\n      }\r\n      return true;\r\n    },\r\n    goBack() {\r\n      this.$emit(\"back\");\r\n      // this.$router.go(-1);\r\n    }\r\n  }\r\n}\r\n</script>\r\n<style >\r\n  .header .el-page-header__content {\r\n    font-size: 14px;\r\n    font-weight: 500;\r\n    color: #303133;\r\n  }\r\n</style>"],"sourceRoot":"src/views/contract/product/group"}]}