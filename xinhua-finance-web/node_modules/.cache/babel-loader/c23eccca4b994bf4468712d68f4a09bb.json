{"remainingRequest":"F:\\东方通\\source\\b_zwj\\xinhua-finance-web\\node_modules\\babel-loader\\lib\\index.js!F:\\东方通\\source\\b_zwj\\xinhua-finance-web\\node_modules\\cache-loader\\dist\\cjs.js??ref--0-0!F:\\东方通\\source\\b_zwj\\xinhua-finance-web\\node_modules\\vue-loader\\lib\\index.js??vue-loader-options!F:\\东方通\\source\\b_zwj\\xinhua-finance-web\\src\\views\\contract\\product\\components\\priceInfo.vue?vue&type=script&lang=js&","dependencies":[{"path":"F:\\东方通\\source\\b_zwj\\xinhua-finance-web\\src\\views\\contract\\product\\components\\priceInfo.vue","mtime":1618794737782},{"path":"F:\\东方通\\source\\b_zwj\\xinhua-finance-web\\node_modules\\cache-loader\\dist\\cjs.js","mtime":499162500000},{"path":"F:\\东方通\\source\\b_zwj\\xinhua-finance-web\\node_modules\\babel-loader\\lib\\index.js","mtime":315532800000},{"path":"F:\\东方通\\source\\b_zwj\\xinhua-finance-web\\node_modules\\cache-loader\\dist\\cjs.js","mtime":499162500000},{"path":"F:\\东方通\\source\\b_zwj\\xinhua-finance-web\\node_modules\\vue-loader\\lib\\index.js","mtime":499162500000}],"contextDependencies":[],"result":["import _toConsumableArray from \"F:/\\u4E1C\\u65B9\\u901A/source/b_zwj/xinhua-finance-web/node_modules/@babel/runtime/helpers/esm/toConsumableArray\";\nimport \"core-js/modules/es6.array.find-index\";\nimport \"core-js/modules/web.dom.iterable\";\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\nimport priceProDialog from \"./priceProDialog\";\nimport { getDictByCode } from \"@/api/system/dict\";\nimport { getValuations } from \"@/api/contract/product/productitem\";\nimport { getListByCate } from \"@/api/contract/product/property\";\nimport bus from '@/assets/js/event-bus';\nexport default {\n  components: {\n    priceProDialog: priceProDialog\n  },\n  name: \"priceInfo\",\n  props: {\n    isView: false,\n    priceInfo: {}\n  },\n  data: function data() {\n    return {\n      dialogForm: {\n        productType: 1,\n        // 1产品类型；2产品项；3组成产品；\n        propType: 1,\n        exclude: '',\n        include: ''\n      },\n      cateId: '',\n      itemColumns: [],\n      excludeIds: [],\n      includeIds: [],\n      currencyTypes: [],\n      openPriceDialog: false\n    };\n  },\n  mounted: function mounted() {\n    var _this2 = this;\n\n    this.onLoad();\n    bus.$on('cateIdBus', function (data) {\n      _this2.cateId = data;\n      _this2.priceInfo.isValuation = 2;\n\n      _this2.valuationChange(_this2.priceInfo.isValuation);\n    });\n  },\n  methods: {\n    showData: function showData(data) {\n      var _this3 = this;\n\n      var _this = this;\n\n      this.priceInfo.isValuation = data.isValuation;\n      this.$forceUpdate();\n      getValuations({\n        prodId: data.id,\n        type: this.productType\n      }).then(function (res) {\n        data = res.data.data;\n        console.log(\"price\", data);\n        data.forEach(function (item, i) {\n          if (i == 0) {\n            JSON.parse(item.valuationValues).forEach(function (column) {\n              _this.includeIds.push(column.propId);\n\n              _this.excludeIds.push(column.propId);\n            });\n          }\n\n          _this3.priceInfo.valuation.push({\n            valuationValue: JSON.parse(item.valuationValues),\n            standardPrice: item.standardPrice,\n            promotionPrice: item.promotionPrice,\n            currency: item.currency\n          });\n        });\n        _this3.dialogForm.include = _this.includeIds.join(',');\n        getListByCate(_this3.dialogForm).then(function (res) {\n          var column = {};\n          res.data.data.forEach(function (item) {\n            column[item.id] = item;\n          });\n\n          _this.includeIds.forEach(function (id) {\n            if (column[id]) {\n              _this3.itemColumns.push(column[id]);\n            }\n          });\n\n          _this3.dialogForm.include = '';\n          console.log(1255, _this3.itemColumns);\n        });\n        _this3.dialogForm.exclude = _this.excludeIds.join(',');\n      });\n    },\n    valuationChange: function valuationChange(value) {\n      var _this4 = this;\n\n      if (value == 1) {\n        // 是否计价 是\n        this.priceInfo.valuation = [{\n          valuationValue: this.handleColumns(),\n          standardPrice: '',\n          promotionPrice: '',\n          currency: ''\n        }];\n\n        if (this.cateId != '') {\n          // // 产品项 需要重新将选择属性的计价属性带出来\n          getListByCate({\n            propType: this.dialogForm.propType,\n            cateId: this.cateId\n          }).then(function (res) {\n            var data = res.data.data;\n\n            _this4.priceAddColumn(data);\n          });\n        }\n      } else if (value == 2) {\n        // 否\n        this.priceInfo.valuation = [];\n        this.itemColumns = [];\n        this.excludeIds = [];\n        this.dialogForm.exclude = '';\n      }\n    },\n    onLoad: function onLoad() {\n      var _this5 = this;\n\n      getDictByCode(this.CONSTANT.CURRENCY_TYPE).then(function (res) {\n        _this5.currencyTypes = res.data.data;\n      });\n    },\n    openDialog: function openDialog() {\n      if (this.productType == 2 && this.dialogForm.cateId == '') {\n        this.$message.warning('请先选择产品类型');\n      } else {\n        this.openPriceDialog = true;\n      }\n    },\n    cancelPriceDialog: function cancelPriceDialog() {\n      this.openPriceDialog = false;\n    },\n    rmPriceColumn: function rmPriceColumn(item) {\n      var _this6 = this;\n\n      this.itemColumns.splice(this.itemColumns.findIndex(function (_) {\n        return _.id === item.id;\n      }), 1);\n      this.excludeIds.splice(this.excludeIds.findIndex(function (_) {\n        return _.id === item.id;\n      }), 1);\n      this.dialogForm.exclude = this.excludeIds.join(','); // 删除 已经添加的行数\n\n      this.priceInfo.valuation.forEach(function (val) {\n        val.valuationValue.splice(_this6.itemColumns.findIndex(function (_) {\n          return _.id === item.id;\n        }), 1);\n      });\n    },\n    // 添加列\n    priceAddColumn: function priceAddColumn(data) {\n      var _this$itemColumns,\n          _this7 = this;\n\n      (_this$itemColumns = this.itemColumns).push.apply(_this$itemColumns, _toConsumableArray(data));\n\n      data.forEach(function (item) {\n        _this7.excludeIds.push(item.id);\n\n        _this7.priceInfo.valuation.forEach(function (val) {\n          val.valuationValue.push({\n            propId: item.id,\n            propCode: item.propCode,\n            propName: item.propName,\n            propValue: ''\n          });\n        });\n      });\n      this.dialogForm.exclude = this.excludeIds.join(',');\n      this.openPriceDialog = false;\n      console.log('add-column', this.priceInfo.valuation);\n    },\n    // 处理列数据\n    handleColumns: function handleColumns() {\n      var columns = [];\n      this.itemColumns.forEach(function (item) {\n        columns.push({\n          propId: item.id,\n          propCode: item.propCode,\n          propName: item.propName,\n          propValue: ''\n        });\n      });\n      return columns;\n    },\n    priceInfoAddRow: function priceInfoAddRow() {\n      this.priceInfo.valuation.push({\n        valuationValue: this.handleColumns(),\n        standardPrice: '',\n        promotionPrice: '',\n        currency: ''\n      });\n      console.log('add-row', this.priceInfo.valuation);\n    },\n    priceInfoRmRow: function priceInfoRmRow(index) {\n      this.priceInfo.valuation.splice(index, 1);\n      this.excludeIds.splice(index, 1);\n      this.dialogForm.exclude = this.excludeIds.join(',');\n    }\n  }\n};",{"version":3,"sources":["priceInfo.vue"],"names":[],"mappings":"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","sourcesContent":["<template>\r\n  <el-form ref=\"priceForm\" :model=\"priceInfo\" label-width=\"100px\" class=\"demo-form-inline\"  size=\"mini\">\r\n    <el-form-item label=\"是否计价\">\r\n      <el-radio-group :disabled=\"isView\" v-model=\"priceInfo.isValuation\" @change=\"valuationChange\">\r\n        <el-radio :label=\"1\">是</el-radio>\r\n        <el-radio :label=\"2\">否</el-radio>\r\n      </el-radio-group>\r\n    </el-form-item>\r\n    <el-form-item label=\"计价方式\" v-show=\"priceInfo.isValuation==1\">\r\n      <el-button type=\"primary\" v-if=\"!isView\" size=\"small\" @click=\"openDialog\" class=\"add-btn\">添加计价属性</el-button>\r\n      <template>\r\n         <el-form \r\n          :model=\"priceInfo\" \r\n          ref=\"inServForm\"\r\n          size=\"small\">\r\n          <el-table border size=\"small\"\r\n            :data=\"priceInfo.valuation\">\r\n            <el-table-column v-for=\"(item, i) in itemColumns\" :key='item.id' prop=\"propValue\" :label=\"item.propName\">\r\n              <template slot=\"header\" slot-scope=\"scope\">\r\n                <span><i v-if=\"item.isRequired==1\" class=\"table-tip\">*</i>{{item.propName}}</span><i v-if=\"!isView\" style=\"float: right; color: #F56C6C;\" class=\"el-icon-remove-outline\" @click=\"rmPriceColumn(item)\"></i>   \r\n              </template>\r\n              <template slot-scope=\"scope\">\r\n                  <el-form-item \r\n                  :rules=\"[{ required:item.isRequired==1?true:false,message:item.showType == 1?`请输入${item.propName}`:`请选择${item.propName}`,trigger:item.showType == 1?'blur':'change'}]\"\r\n                  :prop=\"'valuation.' + scope.$index +'.valuationValue.'+i+'.propValue'\">\r\n                    <el-input :disabled=\"isView\" v-model=\"scope.row.valuationValue[i].propValue\" placeholder=\"请输入\" size=\"mini\" v-if=\"item.showType == 1\" ></el-input>\r\n                    <el-select :disabled=\"isView\" style=\"width:100%\" size=\"mini\" v-model=\"scope.row.valuationValue[i].propValue\" placeholder=\"请选择\"  v-if=\"item.showType == 2\">\r\n                      <el-option v-for=\"(im,t) in item.options\" :key=\"t\" :label=\"im.propValue\" :value=\"im.propValue\"></el-option>\r\n                    </el-select>\r\n                  </el-form-item>\r\n              </template>\r\n            </el-table-column>\r\n            <el-table-column label=\"标准价\">\r\n              <template slot=\"header\" slot-scope=\"scope\">\r\n                <span><i class=\"table-tip\">*</i>标准价</span>   \r\n              </template>\r\n              <template slot-scope=\"scope\">\r\n                <el-form-item \r\n                :prop=\"'valuation.' + scope.$index + '.standardPrice'\"\r\n                :rules=\"[{required:true,message:'请输入标准价',trigger:'blur'}]\">\r\n                  <el-input :disabled=\"isView\" type=\"number\" v-model=\"scope.row.standardPrice\" ></el-input>\r\n                </el-form-item>\r\n              </template>\r\n            </el-table-column>\r\n            <el-table-column label=\"促销价\">\r\n              <template slot-scope=\"scope\">\r\n                <el-input :disabled=\"isView\" type=\"number\" v-model=\"scope.row.promotionPrice\"  class=\"normal-input\"></el-input>\r\n              </template>\r\n            </el-table-column>\r\n            <el-table-column label=\"币种\" >\r\n              <template slot=\"header\" slot-scope=\"scope\">\r\n                <span><i class=\"table-tip\">*</i>币种</span>   \r\n              </template>\r\n              <template slot-scope=\"scope\">\r\n                <el-form-item \r\n                  :prop=\"'valuation.' + scope.$index + '.currency'\"\r\n                  :rules=\"[{required:true,message:'请选择标币种',trigger:'blur'}]\">\r\n                  <el-select :disabled=\"isView\" v-model=\"scope.row.currency\" filterable placeholder=\"请选择\">\r\n                    <el-option v-for=\"(item,i) in currencyTypes\" :key=\"i\" :label=\"item.dictValue\" :value=\"item.dictKey\"></el-option>\r\n                  </el-select>\r\n                </el-form-item>\r\n              </template>\r\n            </el-table-column>\r\n            <el-table-column v-if=\"!isView\" label=\"操作\" fixed=\"right\" width=\"80\">\r\n              <template slot-scope=\"scope\">\r\n                  <el-button v-if=\"scope.$index == 0\" icon=\"el-icon-circle-plus-outline\" type=\"text\" size=\"small\" @click=\"priceInfoAddRow(scope.$index, scope.row)\">新增</el-button>\r\n                  <el-button v-if=\"scope.$index > 0\" icon=\"el-icon-delete\" type=\"text\" size=\"small\" style='color: #E02020;' @click=\"priceInfoRmRow(scope.$index, scope.row)\">删除</el-button>\r\n              </template>\r\n            </el-table-column>\r\n          </el-table>\r\n          </el-form>\r\n      </template>\r\n    </el-form-item>\r\n    <price-pro-dialog dialogTitle=\"添加计价属性\" :dialogForm=\"dialogForm\" :proDialog=\"openPriceDialog\" @resultPrice=\"priceAddColumn\" @cancelPrice=\"cancelPriceDialog\"></price-pro-dialog>\r\n  </el-form>\r\n</template>\r\n<script>\r\nimport priceProDialog from \"./priceProDialog\";\r\nimport {getDictByCode} from \"@/api/system/dict\";\r\nimport {getValuations} from \"@/api/contract/product/productitem\";\r\nimport { getListByCate} from \"@/api/contract/product/property\";\r\nimport bus from '@/assets/js/event-bus';\r\nexport default {\r\n  components:{priceProDialog},\r\n  name:\"priceInfo\",\r\n  props:{\r\n    isView:false,\r\n    priceInfo:{\r\n    }\r\n  },\r\n  data(){\r\n      return {\r\n        dialogForm:{\r\n          productType:1,// 1产品类型；2产品项；3组成产品；\r\n          propType:1,\r\n          exclude:'',\r\n          include:'',\r\n        },\r\n        cateId:'',\r\n        itemColumns:[],\r\n        excludeIds:[],\r\n        includeIds:[],\r\n        currencyTypes:[],\r\n        openPriceDialog:false,\r\n      }\r\n  },\r\n  mounted(){\r\n    this.onLoad()\r\n    bus.$on('cateIdBus',data =>{\r\n      this.cateId = data\r\n      this.priceInfo.isValuation=2\r\n      this.valuationChange(this.priceInfo.isValuation)\r\n    })\r\n  },\r\n  methods:{\r\n    showData(data){\r\n      let _this = this;\r\n      this.priceInfo.isValuation = data.isValuation;\r\n      this.$forceUpdate()\r\n      getValuations({prodId:data.id, type:this.productType}).then(res =>{\r\n        data = res.data.data\r\n        console.log(\"price\",data)\r\n        data.forEach((item ,i)=>{\r\n          if(i==0){\r\n            JSON.parse(item.valuationValues).forEach(column=>{\r\n              _this.includeIds.push(column.propId)\r\n              _this.excludeIds.push(column.propId)\r\n            })\r\n          }\r\n          this.priceInfo.valuation.push({\r\n            valuationValue:JSON.parse(item.valuationValues),\r\n            standardPrice:item.standardPrice,\r\n            promotionPrice:item.promotionPrice,\r\n            currency:item.currency\r\n          });\r\n        })\r\n        this.dialogForm.include = _this.includeIds.join(',');\r\n        getListByCate(this.dialogForm).then(res =>{\r\n          let column={}\r\n          res.data.data.forEach(item=>{\r\n            column[item.id]=item\r\n          })\r\n          _this.includeIds.forEach(id =>{\r\n            if(column[id]){\r\n              this.itemColumns.push(column[id])\r\n            }\r\n          })\r\n          this.dialogForm.include='';\r\n          console.log(1255,this.itemColumns)\r\n        })\r\n        this.dialogForm.exclude = _this.excludeIds.join(',');\r\n      })\r\n    },\r\n    valuationChange(value){\r\n      if(value==1){ // 是否计价 是\r\n        this.priceInfo.valuation=[{\r\n          valuationValue:this.handleColumns(),\r\n          standardPrice:'',\r\n          promotionPrice:'',\r\n          currency:''\r\n        }];\r\n        if(this.cateId !=''){// // 产品项 需要重新将选择属性的计价属性带出来\r\n          getListByCate({propType:this.dialogForm.propType,cateId:this.cateId}).then(res => {\r\n            const data = res.data.data;\r\n            this.priceAddColumn(data)\r\n          });\r\n        }\r\n      }else if(value==2){ // 否\r\n        this.priceInfo.valuation=[]\r\n        this.itemColumns=[]\r\n        this.excludeIds=[]\r\n        this.dialogForm.exclude=''\r\n      }\r\n    },\r\n    onLoad(){\r\n      getDictByCode(this.CONSTANT.CURRENCY_TYPE).then(res => {\r\n        this.currencyTypes=res.data.data\r\n      });\r\n    },\r\n    openDialog(){\r\n      if(this.productType == 2 && this.dialogForm.cateId ==''){\r\n        this.$message.warning('请先选择产品类型');\r\n      }else{\r\n        this.openPriceDialog = true\r\n      }\r\n    },\r\n    cancelPriceDialog(){\r\n      this.openPriceDialog = false\r\n    },\r\n    rmPriceColumn(item){\r\n      this.itemColumns.splice(this.itemColumns.findIndex(_ => {\r\n          return _.id === item.id\r\n       }), 1);\r\n      this.excludeIds.splice(this.excludeIds.findIndex(_ => {\r\n          return _.id === item.id\r\n       }), 1);\r\n      this.dialogForm.exclude = this.excludeIds.join(',');\r\n      // 删除 已经添加的行数\r\n      this.priceInfo.valuation.forEach(val =>{\r\n        val.valuationValue.splice(this.itemColumns.findIndex(_ => {\r\n          return _.id === item.id\r\n        }), 1);\r\n      })\r\n    },\r\n    // 添加列\r\n    priceAddColumn(data) {\r\n      this.itemColumns.push(...data)\r\n      data.forEach(item =>{\r\n        this.excludeIds.push(item.id);\r\n        this.priceInfo.valuation.forEach(val =>{\r\n          val.valuationValue.push({\r\n            propId:item.id,\r\n            propCode:item.propCode,\r\n            propName:item.propName,\r\n            propValue:''\r\n          })\r\n        })\r\n      })\r\n      this.dialogForm.exclude = this.excludeIds.join(',');\r\n      this.openPriceDialog = false;\r\n      console.log('add-column',this.priceInfo.valuation)\r\n    },\r\n    // 处理列数据\r\n    handleColumns(){\r\n      let columns=[]\r\n      this.itemColumns.forEach(item=>{\r\n        columns.push({\r\n          propId:item.id,\r\n          propCode:item.propCode,\r\n          propName:item.propName,\r\n          propValue:''\r\n        })\r\n      })\r\n      return columns\r\n    },\r\n    priceInfoAddRow(){\r\n      \r\n      this.priceInfo.valuation.push({\r\n        valuationValue:this.handleColumns(),\r\n        standardPrice:'',\r\n        promotionPrice:'',\r\n        currency:''\r\n      });\r\n      console.log('add-row',this.priceInfo.valuation)\r\n    },\r\n    priceInfoRmRow(index){\r\n      this.priceInfo.valuation.splice(index, 1);\r\n      this.excludeIds.splice(index, 1);\r\n      this.dialogForm.exclude = this.excludeIds.join(',');\r\n    },\r\n  }\r\n}\r\n</script>\r\n<style lang=\"scss\" scoped>\r\n.add-btn{\r\n  margin-bottom: 1rem;\r\n}\r\n.table-tip{\r\n  color: #F56C6C;\r\n  font-weight: normal;\r\n  vertical-align: middle;\r\n  margin-right: 2px;\r\n  font-size: 14px;\r\n}\r\n.normal-input{\r\n  margin-bottom: 18px;\r\n}\r\n</style>"],"sourceRoot":"src/views/contract/product/components"}]}