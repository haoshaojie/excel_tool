<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="cn.com.cnfic.contractmanage.product.mapper.ProductMapper">

    <!-- 通用查询映射结果 -->
    <resultMap id="productResultMap" type="cn.com.cnfic.contractmanage.product.entity.Product">
        <id column="id" property="id"/>
        <result column="create_time" property="createTime"/>
        <result column="create_user" property="createUser"/>
        <result column="update_time" property="updateTime"/>
        <result column="update_user" property="updateUser"/>
        <result column="is_deleted" property="isDeleted"/>
        <result column="prod_code" property="prodCode"/>
        <result column="prod_name" property="prodName"/>
        <result column="prop_dept" property="propDept"/>
        <result column="prod_type" property="prodType"/>
        <result column="prod_desc" property="prodDesc"/>
        <result column="pro_image" property="proImage"/>
        <result column="release_scope" property="releaseScope"/>
        <result column="added_date" property="addedDate"/>
        <result column="expired_date" property="expiredDate"/>
        <result column="is_valuation" property="isValuation"/>
        <result column="item_sourse" property="itemSourse"/>
        <result column="partner_id" property="partnerId"/>
        <result column="partner_name" property="partnerName"/>
        <result column="share_type" property="shareType"/>
        <result column="share_result" property="shareResult"/>
        <result column="prod_state" property="prodState"/>
    </resultMap>

    <sql id="updateState">
        prod_state = #{prod.prodState}
        <if test="prod.addedDate != null">
            ,added_date = #{prod.addedDate}
        </if>
        <if test="prod.expiredDate != null">
            ,expired_date = #{prod.expiredDate}
        </if>
    </sql>
    <select id="selectProductPage" resultMap="productResultMap">
        select * from pro_product where is_deleted = 0
    </select>
    <update id="updateState">
        UPDATE pro_product
        SET
        <include refid="updateState"></include>
        <where>
            <foreach collection="ids" index="index" item="id" open=" id in (" separator="," close=")">
                #{id}
            </foreach>
        </where>
    </update>
    <update id="updateStateByDate">
        UPDATE pro_product
        SET
        <include refid="updateState"></include>
        <where>
            <if test="prod.addedDate != null">
                added_date <![CDATA[ <= ]]> #{prod.addedDate},
            </if>
            <if test="prod.expiredDate != null">
                and expired_date <![CDATA[ <= ]]> #{prod.expiredDate}
            </if>
        </where>
    </update>

    <update id="updateProdById" parameterType="cn.com.cnfic.contractmanage.product.entity.Product" >
        UPDATE pro_product
        SET id = #{id}
        <if test="prodCode !=null and prodCode !=''">
            ,prod_code = #{prodCode}
        </if>
        <if test="prodName !=null and prodName !=''">
            ,prod_name = #{prodName}
        </if>
        <if test="propDept !=null and propDept !=''">
            ,prop_dept = #{propDept}
        </if>
        <if test="prodType !=null and prodType !=''">
            ,prod_type = #{prodType}
        </if>
        <if test="prodDesc !=null and prodDesc !=''">
            ,prod_desc = #{prodDesc}
        </if>
        <if test="proImage !=null and proImage !=''">
            ,pro_image = #{proImage}
        </if>
        <if test="releaseScope !=null and releaseScope !=''">
            ,release_scope = #{releaseScope}
        </if>
        <if test="addedDate !=null">
            ,added_date = #{addedDate}
        </if>
        <if test="expiredDate !=null">
            ,expired_date = #{expiredDate}
        </if>
        <if test="isValuation !=null and isValuation !=''">
            ,is_valuation = #{isValuation}
        </if>
        <if test="itemSourse !=null and itemSourse !=''">
            ,item_sourse = #{itemSourse}
        </if>
        <if test="partnerId !=null and partnerId !=''">
            ,partner_id = #{partnerId}
        </if>
        <if test="partnerName !=null and partnerName !=''">
            ,partner_name = #{partnerName}
        </if>
        <if test="shareType !=null and shareType !=''">
            ,share_type = #{shareType}
        </if>
        <if test="shareResult !=null and shareResult !=''">
            ,share_result = #{shareResult}
        </if>
        <if test="prodState !=null and prodState !=''">
            ,prod_state = #{prodState}
        </if>
        <if test="updateTime !=null">
            ,update_time = #{updateTime}
        </if>
        <if test="updateUser !=null and updateUser !=''">
            ,update_user = #{updateUser}
        </if>
        WHERE
            id = #{id}
    </update>

    <select id="selectProdAndValuation" resultType="java.util.Map">
        SELECT
        i.id id,
        i.prod_code prodCode,
        i.prod_name prodName,
        i.prop_dept propDept,
        i.prod_type prodType,
        i.prod_desc prodDesc,
        i.release_scope releaseScope,
        i.added_date addedDate,
        i.expired_date expiredDate,
        v.promotion_price promotionPrice,
        v.standard_price standardPrice,
        v.currency,
        V.valuation_values valuationValues
        FROM
        pro_product i
        LEFT JOIN pro_valuation v ON i.id = v.prod_id
        AND v.type = '1' AND v.is_deleted = 0
        <where>
            i.is_deleted = 0
            <if test="item.prodName != null">
                and i.prod_name like CONCAT(#{item.prodName},'%' )
            </if>
            <if test="item.prodCode != null">
                and i.prod_code like CONCAT(#{item.prodCode},'%' )
            </if>
            <if test="item.releaseScope != null">
                and i.release_scope = #{item.releaseScope}
            </if>
            <if test="item.prodState != null">
                and i.prod_state = #{item.prodState}
            </if>
            <if test="item.propDept != null">
                and i.prop_dept = #{item.propDept}
            </if>
            <if test="item.prodType != null">
                and i.prod_type = #{item.prodType}
            </if>
            <if test="item.createStartTime != null and item.createEndTime">
                and i.create_time between #{item.createStartTime} AND #{item.createEndTime}
            </if>
            <if test="item.updateStartTime != null and item.updateEndTime">
                and i.update_time between #{item.updateStartTime} AND #{item.updateEndTime}
            </if>
        </where>
    </select>
</mapper>
