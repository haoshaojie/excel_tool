<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="cn.com.cnfic.contractmanage.contract.mapper.NcMapper">

    <!-- 通用查询映射结果 -->
    <resultMap id="ncResultMap" type="cn.com.cnfic.contractmanage.contract.vo.NcVO">
        <id column="id" property="id"/>
        <result column="create_time" property="createTime"/>
        <result column="create_user" property="createUser"/>
        <result column="update_time" property="updateTime"/>
        <result column="update_user" property="updateUser"/>
        <result column="is_deleted" property="isDeleted"/>
        <result column="financial_org" property="financialOrg"/>
        <result column="project_name" property="projectName"/>
        <result column="con_nc_no" property="conNcNo"/>
        <result column="con_name" property="conName"/>
        <result column="cust_name" property="custName"/>
        <result column="con_start_time" property="conStartTime"/>
        <result column="con_end_time" property="conEndTime"/>
        <result column="con_amount" property="conAmount"/>
        <result column="cust_character1" property="custCharacter1"/>
        <result column="cust_character2" property="custCharacter2"/>
        <result column="cust_character3" property="custCharacter3"/>
        <result column="contract_party" property="contractParty"/>
        <result column="sign_type" property="signType"/>
        <result column="actual_service_cust" property="actualServiceCust"/>
        <result column="salesman_phone" property="salesmanPhone"/>
        <result column="cont_finish_state" property="contFinishState"/>
        <result column="service_request" property="serviceRequest"/>
        <result column="sign_date" property="signDate"/>
        <result column="finish_desc" property="finishDesc"/>
        <result column="revenue_method" property="revenueMethod"/>
        <result column="work_start_time" property="workStartTime"/>
        <result column="work_end_time" property="workEndTime"/>
        <result column="effective_date" property="effectiveDate"/>
        <result column="third_party_nature" property="thirdPartyNature"/>
        <result column="third_party_cust" property="thirdPartyCust"/>
        <result column="sign_dept" property="signDept"/>
        <result column="salesman" property="salesman"/>
        <result column="syn_time" property="synTime"/>
        <result column="sync_state" property="syncState"/>
        <result column="is_create" property="isCreate"/>

        <!--关联产品，一对多-->
        <collection property="proList" javaType="list" ofType="cn.com.cnfic.contractmanage.contract.entity.NcProduct" >
            <id column="pid" property="id" />
            <result column="nc_id" property="ncId"/>
            <result column="prod_name" property="prodName"/>
            <result column="prod_dept" property="prodDept"/>
            <result column="prod_dept_id" property="proDeptId"/>
            <result column="prod_platform" property="prodPlatform"/>
            <result column="prod_price" property="prodPrice"/>
            <result column="prod_num" property="prodNum"/>
            <result column="prod_amount" property="prodAmount"/>
            <result column="prod_org" property="prodOrg"/>
            <result column="is_create" property="isCreate"/>
            <result column="con_id" property="conId"/>
            <result column="create_time" property="createTime"/>
            <result column="create_user" property="createUser"/>
            <result column="update_time" property="updateTime"/>
            <result column="update_user" property="updateUser"/>
            <result column="is_deleted" property="isDeleted"/>
        </collection>
    </resultMap>


    <select id="selectNcPageData" resultMap="ncResultMap" parameterType="cn.com.cnfic.contractmanage.contract.dto.NcDTO">
        select distinct n.* from con_nc n left join con_nc_product p on n.id = p.nc_id where n.is_deleted = 0 and p.is_deleted = 0
        <if test="ids!=null and ids.size()>0">
            and p.prod_dept_id in
            <foreach item="item" index="index" collection="ids" open="(" separator="," close=")">
                #{item}
            </foreach>
        </if>
        <if test="ids == null or ids.size()==0">
            and 2=1
        </if>
		<if test="nc.conNcNo != null and nc.conNcNo != ''">
            and n.con_nc_no like concat('%',#{nc.conNcNo},'%')
        </if>
        <if test="nc.conName != null and nc.conName != ''">
            and n.con_name like concat('%',#{nc.conName},'%')
        </if>
        <if test="nc.custName != null and nc.custName != ''">
            and n.cust_name like concat('%',#{nc.custName},'%')
        </if>
        <if test="nc.signDept != null and nc.signDept != ''">
            and n.sign_dept like concat('%',#{nc.signDept},'%')
        </if>
        <if test="nc.salesman != null and nc.salesman != ''">
            and n.salesman like concat('%',#{nc.salesman},'%')
        </if>
        <if test="nc.signDateStartTime != null and nc.signDateEndTime != null">
            and n.sign_date between #{nc.signDateStartTime} and #{nc.signDateEndTime}
        </if>
        <if test="nc.synTimeStartTime != null and nc.synTimeEndTime != null">
            and n.syn_time between #{nc.synTimeStartTime} and #{nc.synTimeEndTime}
        </if>
    </select>

    <select id="selectDetailById" resultMap="ncResultMap">
        select * from con_nc n left join con_nc_product p on n.id = p.nc_id where n.id = #{id} and n.is_deleted = 0 and p.is_deleted = 0
        <if test="depIds!=null and depIds.size()>0">
            and p.prod_dept_id in
            <foreach item="item" index="index" collection="depIds" open="(" separator="," close=")">
                #{item}
            </foreach>
        </if>
        <if test="depIds == null or depIds.size()==0">
            and 2=1
        </if>
    </select>
</mapper>
